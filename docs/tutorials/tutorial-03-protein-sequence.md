# æ•™ç¨‹ 03ï¼šè›‹ç™½è´¨åºåˆ—æ”¯æŒ

## ğŸ“‹ æœ¬ç« å¯¼è§ˆ

- **ä½ å°†æŒæ¡çš„æŠ€èƒ½**ï¼š
  - ç†è§£è›‹ç™½è´¨åºåˆ—çš„ç‰¹ç‚¹
  - å®ç° ProteinSequence ç±»
  - è®¡ç®—è›‹ç™½è´¨ç†åŒ–æ€§è´¨ï¼ˆåˆ†å­é‡ã€ç­‰ç”µç‚¹ç­‰ï¼‰
  - åˆ†ææ°¨åŸºé…¸ç»„æˆå’Œç–æ°´æ€§
  - æ„å»ºå®Œæ•´çš„"ä¸­å¿ƒæ³•åˆ™"å·¥ä½œæµ

- **å‰ç½®çŸ¥è¯†**ï¼š
  - å®Œæˆæ•™ç¨‹ 01 å’Œ 02
  - ç†è§£æ°¨åŸºé…¸çš„åŸºæœ¬æ¦‚å¿µ

- **æ ¸å¿ƒæŒ‘æˆ˜**ï¼šè›‹ç™½è´¨æœ‰ 20 ç§æ°¨åŸºé…¸ï¼Œå¦‚ä½•é«˜æ•ˆåœ°å¤„ç†å’Œåˆ†æï¼Ÿ

---

## ğŸ“š ç†è§£è›‹ç™½è´¨åºåˆ—

### ä»€ä¹ˆæ˜¯è›‹ç™½è´¨ï¼Ÿ

è›‹ç™½è´¨æ˜¯ç”Ÿå‘½æ´»åŠ¨çš„æ‰§è¡Œè€…ï¼Œç”±æ°¨åŸºé…¸é“¾ç»„æˆï¼š

```
DNA â†’ RNA â†’ è›‹ç™½è´¨
         â†‘
      æˆ‘ä»¬åœ¨è¿™é‡Œ
```

### 20 ç§æ ‡å‡†æ°¨åŸºé…¸

| ç¬¦å· | ä¸‰å­—æ¯ | åç§° | æ€§è´¨ |
|------|--------|------|------|
| A | Ala | ä¸™æ°¨é…¸ | ç–æ°´ï¼Œå° |
| C | Cys | åŠèƒ±æ°¨é…¸ | å¯å½¢æˆäºŒç¡«é”® |
| D | Asp | å¤©å†¬æ°¨é…¸ | é…¸æ€§ï¼Œå¸¦è´Ÿç”µ |
| E | Glu | è°·æ°¨é…¸ | é…¸æ€§ï¼Œå¸¦è´Ÿç”µ |
| F | Phe | è‹¯ä¸™æ°¨é…¸ | ç–æ°´ï¼ŒèŠ³é¦™æ— |
| G | Gly | ç”˜æ°¨é…¸ | æœ€å°ï¼Œçµæ´» |
| H | His | ç»„æ°¨é…¸ | ç¢±æ€§ï¼Œå¯å¸¦æ­£ç”µ |
| I | Ile | å¼‚äº®æ°¨é…¸ | ç–æ°´ |
| K | Lys | èµ–æ°¨é…¸ | ç¢±æ€§ï¼Œå¸¦æ­£ç”µ |
| L | Leu | äº®æ°¨é…¸ | ç–æ°´ |
| M | Met | ç”²ç¡«æ°¨é…¸ | èµ·å§‹æ°¨åŸºé…¸ |
| N | Asn | å¤©å†¬é…°èƒº | äº²æ°´ |
| P | Pro | è„¯æ°¨é…¸ | ç»“æ„é™åˆ¶ |
| Q | Gln | è°·æ°¨é…°èƒº | äº²æ°´ |
| R | Arg | ç²¾æ°¨é…¸ | ç¢±æ€§ï¼Œå¸¦æ­£ç”µ |
| S | Ser | ä¸æ°¨é…¸ | äº²æ°´ï¼Œå¯ç£·é…¸åŒ– |
| T | Thr | è‹æ°¨é…¸ | äº²æ°´ï¼Œå¯ç£·é…¸åŒ– |
| V | Val | ç¼¬æ°¨é…¸ | ç–æ°´ |
| W | Trp | è‰²æ°¨é…¸ | ç–æ°´ï¼ŒèŠ³é¦™æ— |
| Y | Tyr | é…ªæ°¨é…¸ | èŠ³é¦™æ—ï¼Œå¯ç£·é…¸åŒ– |

### è›‹ç™½è´¨åˆ†æçš„æ„ä¹‰

**ä¸ºä»€ä¹ˆè¦åˆ†æè›‹ç™½è´¨åºåˆ—ï¼Ÿ**

1. **åŠŸèƒ½é¢„æµ‹**ï¼šåºåˆ— â†’ ç»“æ„ â†’ åŠŸèƒ½
2. **è›‹ç™½è´¨å·¥ç¨‹**ï¼šæ”¹é€ è›‹ç™½è´¨æ€§è´¨
3. **è¯ç‰©è®¾è®¡**ï¼šé¶ç‚¹åˆ†æ
4. **è¿›åŒ–ç ”ç©¶**ï¼šåºåˆ—ç›¸ä¼¼æ€§åˆ†æ

**å¸¸è§åˆ†ææŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| åˆ†å­é‡ | è›‹ç™½è´¨è´¨é‡ | ç”µæ³³ã€è´¨è°± |
| ç­‰ç”µç‚¹ (pI) | å‡€ç”µè·ä¸º 0 çš„ pH | çº¯åŒ–ã€ç”µæ³³ |
| ç–æ°´æ€§ | äº²/ç–æ°´ç¨‹åº¦ | è†œè›‹ç™½é¢„æµ‹ |
| æ¶ˆå…‰ç³»æ•° | å¸å…‰èƒ½åŠ› | æµ“åº¦æµ‹å®š |

---

## ğŸ”§ è®¾è®¡æˆ‘ä»¬çš„å®ç°

### ä¸æ ¸é…¸åºåˆ—çš„åŒºåˆ«

| ç‰¹æ€§ | DNA/RNA | è›‹ç™½è´¨ |
|------|---------|--------|
| å•å…ƒæ•°é‡ | 4 ç§ç¢±åŸº | 20 ç§æ°¨åŸºé…¸ |
| äº’è¡¥æ¦‚å¿µ | æœ‰ï¼ˆé…å¯¹ï¼‰ | æ—  |
| æ–¹å‘ | 5' â†’ 3' | Nç«¯ â†’ Cç«¯ |
| åŒ–å­¦æ€§è´¨ | è¾ƒç»Ÿä¸€ | å·®å¼‚å¤§ |

**è®¾è®¡å†³ç­–**ï¼šè›‹ç™½è´¨åºåˆ—ä¸ç»§æ‰¿ `BaseSequence`ï¼Œå› ä¸ºæ²¡æœ‰"äº’è¡¥"æ¦‚å¿µã€‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ProteinSequence                            â”‚
â”‚  â”œâ”€â”€ _sequence: str (æ°¨åŸºé…¸åºåˆ—)                         â”‚
â”‚  â”œâ”€â”€ molecular_weight() â†’ float                        â”‚
â”‚  â”œâ”€â”€ isoelectric_point() â†’ float                       â”‚
â”‚  â”œâ”€â”€ amino_acid_composition() â†’ dict                   â”‚
â”‚  â”œâ”€â”€ hydrophobicity_profile() â†’ list[float]            â”‚
â”‚  â””â”€â”€ extinction_coefficient() â†’ float                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚ translate()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RNASequence                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä»£ç å®ç°

### æ­¥éª¤ 1ï¼šåˆ›å»º ProteinSequence ç±»

åˆ›å»º `src/genomeflow/protein.py`ï¼š

```python
"""
è›‹ç™½è´¨åºåˆ—ç±»ã€‚

è›‹ç™½è´¨æ˜¯ç”±æ°¨åŸºé…¸ç»„æˆçš„ç”Ÿç‰©å¤§åˆ†å­ï¼Œ
æ˜¯åŸºå› è¡¨è¾¾çš„æœ€ç»ˆäº§ç‰©ï¼Œæ‰§è¡Œå„ç§ç”Ÿç‰©å­¦åŠŸèƒ½ã€‚
"""

from __future__ import annotations

from collections import Counter
from dataclasses import dataclass
from typing import Iterator


class InvalidProteinError(ValueError):
    """è›‹ç™½è´¨åºåˆ—åŒ…å«æ— æ•ˆå­—ç¬¦æ—¶æŠ›å‡ºã€‚"""
    pass


# 20 ç§æ ‡å‡†æ°¨åŸºé…¸
AMINO_ACIDS: frozenset[str] = frozenset("ACDEFGHIKLMNPQRSTVWY")

# ç‰¹æ®Šç¬¦å·
# * = ç»ˆæ­¢å¯†ç å­äº§ç”Ÿçš„ç»ˆæ­¢ç¬¦
# X = æœªçŸ¥æ°¨åŸºé…¸
# - = æ¯”å¯¹ä¸­çš„é—´éš™
EXTENDED_AMINO_ACIDS: frozenset[str] = frozenset("ACDEFGHIKLMNPQRSTVWY*X-")


# æ°¨åŸºé…¸åˆ†å­é‡ï¼ˆDaï¼‰
# è¿™æ˜¯æ®‹åŸºåˆ†å­é‡ï¼ˆå·²å‡å»æ°´ï¼Œå› ä¸ºè‚½é”®å½¢æˆä¼šè„±æ°´ï¼‰
AMINO_ACID_WEIGHTS: dict[str, float] = {
    "A": 89.09,   # Alanine
    "C": 121.15,  # Cysteine
    "D": 133.10,  # Aspartic acid
    "E": 147.13,  # Glutamic acid
    "F": 165.19,  # Phenylalanine
    "G": 75.07,   # Glycine
    "H": 155.16,  # Histidine
    "I": 131.17,  # Isoleucine
    "K": 146.19,  # Lysine
    "L": 131.17,  # Leucine
    "M": 149.21,  # Methionine
    "N": 132.12,  # Asparagine
    "P": 115.13,  # Proline
    "Q": 146.15,  # Glutamine
    "R": 174.20,  # Arginine
    "S": 105.09,  # Serine
    "T": 119.12,  # Threonine
    "V": 117.15,  # Valine
    "W": 204.23,  # Tryptophan
    "Y": 181.19,  # Tyrosine
}

# ç–æ°´æ€§æŒ‡æ•°ï¼ˆKyte-Doolittle é‡è¡¨ï¼‰
# æ­£å€¼è¡¨ç¤ºç–æ°´ï¼Œè´Ÿå€¼è¡¨ç¤ºäº²æ°´
HYDROPHOBICITY: dict[str, float] = {
    "A": 1.8,    # ç–æ°´
    "C": 2.5,
    "D": -3.5,   # äº²æ°´ï¼ˆé…¸æ€§ï¼‰
    "E": -3.5,
    "F": 2.8,    # å¼ºç–æ°´ï¼ˆèŠ³é¦™æ—ï¼‰
    "G": -0.4,
    "H": -3.2,
    "I": 4.5,    # å¼ºç–æ°´
    "K": -3.9,   # äº²æ°´ï¼ˆç¢±æ€§ï¼‰
    "L": 3.8,
    "M": 1.9,
    "N": -3.5,
    "P": -1.6,
    "Q": -3.5,
    "R": -4.5,   # æœ€äº²æ°´
    "S": -0.8,
    "T": -0.7,
    "V": 4.2,    # å¼ºç–æ°´
    "W": -0.9,
    "Y": -1.3,
}

# æ°¨åŸºé…¸ pKa å€¼ï¼ˆç”¨äºè®¡ç®—ç­‰ç”µç‚¹ï¼‰
# pKa_COOH: Cç«¯ç¾§åŸº
# pKa_NH2: Nç«¯æ°¨åŸº
# pKa_side: ä¾§é“¾ï¼ˆå¦‚æœå¯è§£ç¦»ï¼‰
PKA_VALUES: dict[str, dict[str, float]] = {
    "D": {"side": 3.9},   # å¤©å†¬æ°¨é…¸ä¾§é“¾ç¾§åŸº
    "E": {"side": 4.1},   # è°·æ°¨é…¸ä¾§é“¾ç¾§åŸº
    "H": {"side": 6.0},   # ç»„æ°¨é…¸ä¾§é“¾å’ªå”‘
    "C": {"side": 8.3},   # åŠèƒ±æ°¨é…¸ä¾§é“¾å·¯åŸº
    "Y": {"side": 10.1},  # é…ªæ°¨é…¸ä¾§é“¾é…šç¾ŸåŸº
    "K": {"side": 10.5},  # èµ–æ°¨é…¸ä¾§é“¾æ°¨åŸº
    "R": {"side": 12.5},  # ç²¾æ°¨é…¸ä¾§é“¾èƒåŸº
}

# Nç«¯å’ŒCç«¯çš„ pKa
PKA_N_TERMINUS = 9.69
PKA_C_TERMINUS = 2.34


@dataclass(frozen=True)
class AminoAcidComposition:
    """æ°¨åŸºé…¸ç»„æˆåˆ†æç»“æœã€‚"""
    counts: dict[str, int]
    frequencies: dict[str, float]
    total: int

    def __str__(self) -> str:
        lines = [f"æ€»æ°¨åŸºé…¸æ•°: {self.total}"]
        for aa in sorted(self.counts.keys()):
            count = self.counts[aa]
            freq = self.frequencies[aa]
            lines.append(f"  {aa}: {count:4d} ({freq:5.1%})")
        return "\n".join(lines)


@dataclass(frozen=True)
class ProteinProperties:
    """è›‹ç™½è´¨ç†åŒ–æ€§è´¨ã€‚"""
    molecular_weight: float
    isoelectric_point: float
    charge_at_ph7: float
    gravy: float  # Grand Average of Hydropathy
    extinction_coefficient: tuple[float, float]  # (è¿˜åŸæ€, æ°§åŒ–æ€)


class ProteinSequence:
    """
    è¡¨ç¤ºä¸€æ¡è›‹ç™½è´¨ï¼ˆæ°¨åŸºé…¸ï¼‰åºåˆ—ã€‚

    è›‹ç™½è´¨åºåˆ—ä½¿ç”¨å•å­—æ¯æ°¨åŸºé…¸ä»£ç è¡¨ç¤ºã€‚
    æ”¯æŒ 20 ç§æ ‡å‡†æ°¨åŸºé…¸ï¼Œä»¥åŠä¸€äº›ç‰¹æ®Šç¬¦å·ã€‚

    ç¤ºä¾‹ï¼š
        >>> protein = ProteinSequence("MKFLILLFNILCLFPVLAADNH")
        >>> protein.molecular_weight()
        2567.89
    """

    # å…è®¸çš„å­—ç¬¦ï¼šæ ‡å‡†æ°¨åŸºé…¸ + ç‰¹æ®Šç¬¦å·
    VALID_CHARS: frozenset[str] = EXTENDED_AMINO_ACIDS

    def __init__(self, sequence: str, strict: bool = True) -> None:
        """
        åˆ›å»ºè›‹ç™½è´¨åºåˆ—å¯¹è±¡ã€‚

        Args:
            sequence: æ°¨åŸºé…¸åºåˆ—ï¼ˆå•å­—æ¯ä»£ç ï¼‰
            strict: ä¸¥æ ¼æ¨¡å¼ã€‚å¦‚æœä¸º Trueï¼Œåªæ¥å— 20 ç§æ ‡å‡†æ°¨åŸºé…¸ï¼›
                   å¦‚æœä¸º Falseï¼Œæ¥å— Xï¼ˆæœªçŸ¥ï¼‰å’Œ *ï¼ˆç»ˆæ­¢ï¼‰ç­‰ç¬¦å·ã€‚

        Raises:
            InvalidProteinError: å¦‚æœåºåˆ—åŒ…å«æ— æ•ˆå­—ç¬¦
        """
        normalized = sequence.upper()

        # éªŒè¯
        valid_set = AMINO_ACIDS if strict else self.VALID_CHARS
        invalid_chars = set(normalized) - valid_set
        if invalid_chars:
            raise InvalidProteinError(
                f"åºåˆ—åŒ…å«æ— æ•ˆå­—ç¬¦: {invalid_chars}ã€‚"
                f"æœ‰æ•ˆæ°¨åŸºé…¸: {sorted(valid_set)}"
            )

        self._sequence = normalized
        self._strict = strict

    @property
    def sequence(self) -> str:
        """è¿”å›åºåˆ—å­—ç¬¦ä¸²ã€‚"""
        return self._sequence

    def __len__(self) -> int:
        return len(self._sequence)

    def __getitem__(self, index: int | slice) -> str:
        return self._sequence[index]

    def __iter__(self) -> Iterator[str]:
        return iter(self._sequence)

    def __str__(self) -> str:
        return self._sequence

    def __repr__(self) -> str:
        if len(self._sequence) > 50:
            display = f"{self._sequence[:25]}...{self._sequence[-25:]}"
        else:
            display = self._sequence
        return f"ProteinSequence('{display}')"

    def __eq__(self, other: object) -> bool:
        if isinstance(other, ProteinSequence):
            return self._sequence == other._sequence
        if isinstance(other, str):
            return self._sequence == other.upper()
        return NotImplemented

    def __hash__(self) -> int:
        return hash(self._sequence)

    def molecular_weight(self) -> float:
        """
        è®¡ç®—è›‹ç™½è´¨åˆ†å­é‡ï¼ˆDaï¼‰ã€‚

        åˆ†å­é‡ = Î£(å„æ°¨åŸºé…¸æ®‹åŸºåˆ†å­é‡) + æ°´åˆ†å­åˆ†å­é‡
        ï¼ˆNç«¯å’ŒCç«¯å„ä¿ç•™ä¸€ä¸ªH/OHï¼Œå½¢æˆå®Œæ•´å¤šè‚½ï¼‰

        Returns:
            åˆ†å­é‡ï¼ˆé“å°”é¡¿ï¼‰

        ç¤ºä¾‹ï¼š
            >>> ProteinSequence("MK").molecular_weight()
            277.40  # 149.21 + 146.19 - 18.0 (è‚½é”®è„±æ°´)
        """
        # è®¡ç®—æ®‹åŸºåˆ†å­é‡ä¹‹å’Œ
        weight = sum(
            AMINO_ACID_WEIGHTS.get(aa, 0.0)
            for aa in self._sequence
            if aa in AMINO_ACID_WEIGHTS
        )

        # å‡å»å½¢æˆè‚½é”®è„±å»çš„æ°´ï¼ˆn-1 ä¸ªè‚½é”®ï¼‰
        num_peptide_bonds = max(0, len(self._sequence) - 1)
        water_weight = 18.015  # H2O åˆ†å­é‡
        weight -= num_peptide_bonds * water_weight

        # åŠ ä¸Šä¸€ä¸ªæ°´ï¼ˆNç«¯çš„Hå’ŒCç«¯çš„OHï¼‰
        weight += water_weight

        return round(weight, 2)

    def amino_acid_composition(self) -> AminoAcidComposition:
        """
        åˆ†ææ°¨åŸºé…¸ç»„æˆã€‚

        Returns:
            AminoAcidComposition å¯¹è±¡ï¼ŒåŒ…å«è®¡æ•°å’Œé¢‘ç‡

        ç¤ºä¾‹ï¼š
            >>> protein = ProteinSequence("AAAMKKK")
            >>> comp = protein.amino_acid_composition()
            >>> comp.counts["A"]
            3
        """
        # åªç»Ÿè®¡æ ‡å‡†æ°¨åŸºé…¸
        standard_seq = [aa for aa in self._sequence if aa in AMINO_ACIDS]
        counts = Counter(standard_seq)
        total = len(standard_seq)

        frequencies = {
            aa: count / total if total > 0 else 0.0
            for aa, count in counts.items()
        }

        return AminoAcidComposition(
            counts=dict(counts),
            frequencies=frequencies,
            total=total,
        )

    def hydrophobicity_profile(self, window: int = 9) -> list[float]:
        """
        è®¡ç®—ç–æ°´æ€§åˆ†å¸ƒï¼ˆæ»‘åŠ¨çª—å£å¹³å‡ï¼‰ã€‚

        ä½¿ç”¨ Kyte-Doolittle é‡è¡¨è®¡ç®—æ¯ä¸ªä½ç½®çš„ç–æ°´æ€§ã€‚
        æ­£å€¼è¡¨ç¤ºç–æ°´åŒºåŸŸï¼Œå¯èƒ½æ˜¯è·¨è†œåŒºæˆ–è›‹ç™½è´¨å†…éƒ¨ã€‚

        Args:
            window: æ»‘åŠ¨çª—å£å¤§å°ï¼Œé€šå¸¸ç”¨ 7-11

        Returns:
            æ¯ä¸ªä½ç½®çš„ç–æ°´æ€§å€¼åˆ—è¡¨

        ç¤ºä¾‹ï¼š
            >>> protein = ProteinSequence("MILVAGFYW")
            >>> profile = protein.hydrophobicity_profile(window=3)
        """
        if len(self._sequence) < window:
            return []

        profile: list[float] = []
        half_window = window // 2

        for i in range(half_window, len(self._sequence) - half_window):
            window_seq = self._sequence[i - half_window:i + half_window + 1]
            values = [
                HYDROPHOBICITY.get(aa, 0.0)
                for aa in window_seq
                if aa in HYDROPHOBICITY
            ]
            if values:
                avg = sum(values) / len(values)
                profile.append(round(avg, 2))

        return profile

    def gravy(self) -> float:
        """
        è®¡ç®— GRAVYï¼ˆGrand Average of Hydropathyï¼‰ã€‚

        GRAVY æ˜¯æ‰€æœ‰æ°¨åŸºé…¸ç–æ°´æ€§çš„å¹³å‡å€¼ã€‚
        æ­£å€¼è¡¨ç¤ºè›‹ç™½è´¨æ•´ä½“ç–æ°´ï¼ˆå¯èƒ½æ˜¯è†œè›‹ç™½ï¼‰ã€‚
        è´Ÿå€¼è¡¨ç¤ºè›‹ç™½è´¨æ•´ä½“äº²æ°´ï¼ˆå¯èƒ½æ˜¯å¯æº¶è›‹ç™½ï¼‰ã€‚

        Returns:
            GRAVY å€¼

        ç¤ºä¾‹ï¼š
            >>> ProteinSequence("ILVAG").gravy()  # ç–æ°´æ®‹åŸº
            3.16
            >>> ProteinSequence("DEKER").gravy()  # äº²æ°´æ®‹åŸº
            -3.5
        """
        values = [
            HYDROPHOBICITY.get(aa, 0.0)
            for aa in self._sequence
            if aa in HYDROPHOBICITY
        ]
        if not values:
            return 0.0
        return round(sum(values) / len(values), 2)

    def _calculate_charge(self, ph: float) -> float:
        """
        è®¡ç®—åœ¨æŒ‡å®š pH ä¸‹çš„å‡€ç”µè·ã€‚

        ä½¿ç”¨ Henderson-Hasselbalch æ–¹ç¨‹è®¡ç®—æ¯ä¸ªå¯è§£ç¦»åŸºå›¢çš„ç”µè·ã€‚
        """
        charge = 0.0

        # Nç«¯æ°¨åŸºï¼ˆæ­£ç”µè·ï¼‰
        charge += 1.0 / (1.0 + 10 ** (ph - PKA_N_TERMINUS))

        # Cç«¯ç¾§åŸºï¼ˆè´Ÿç”µè·ï¼‰
        charge -= 1.0 / (1.0 + 10 ** (PKA_C_TERMINUS - ph))

        # ä¾§é“¾
        for aa in self._sequence:
            if aa not in PKA_VALUES:
                continue

            pka = PKA_VALUES[aa]["side"]

            if aa in ("D", "E", "C", "Y"):
                # é…¸æ€§ä¾§é“¾ï¼ˆå¤±å»Hå¸¦è´Ÿç”µï¼‰
                charge -= 1.0 / (1.0 + 10 ** (pka - ph))
            else:
                # ç¢±æ€§ä¾§é“¾ï¼ˆè·å¾—Hå¸¦æ­£ç”µï¼‰
                charge += 1.0 / (1.0 + 10 ** (ph - pka))

        return charge

    def isoelectric_point(self) -> float:
        """
        è®¡ç®—ç­‰ç”µç‚¹ï¼ˆpIï¼‰ã€‚

        ç­‰ç”µç‚¹æ˜¯è›‹ç™½è´¨å‡€ç”µè·ä¸ºé›¶æ—¶çš„ pH å€¼ã€‚
        åœ¨ç­‰ç”µç‚¹æ—¶ï¼Œè›‹ç™½è´¨åœ¨ç”µåœºä¸­ä¸ç§»åŠ¨ã€‚

        ä½¿ç”¨äºŒåˆ†æ³•æœç´¢å‡€ç”µè·ä¸º 0 çš„ pH å€¼ã€‚

        Returns:
            ç­‰ç”µç‚¹ pH å€¼

        ç¤ºä¾‹ï¼š
            >>> ProteinSequence("MKFLK").isoelectric_point()
            10.0  # å¯Œå«ç¢±æ€§æ°¨åŸºé…¸
        """
        # äºŒåˆ†æŸ¥æ‰¾
        ph_low, ph_high = 0.0, 14.0

        while ph_high - ph_low > 0.01:
            ph_mid = (ph_low + ph_high) / 2
            charge = self._calculate_charge(ph_mid)

            if charge > 0:
                ph_low = ph_mid
            else:
                ph_high = ph_mid

        return round((ph_low + ph_high) / 2, 2)

    def charge_at_ph(self, ph: float = 7.0) -> float:
        """
        è®¡ç®—åœ¨æŒ‡å®š pH ä¸‹çš„å‡€ç”µè·ã€‚

        Args:
            ph: pH å€¼ï¼Œé»˜è®¤ 7.0ï¼ˆç”Ÿç† pHï¼‰

        Returns:
            å‡€ç”µè·

        ç¤ºä¾‹:
            >>> ProteinSequence("DDDKKK").charge_at_ph(7.0)
            çº¦ç­‰äº 0ï¼ˆ3ä¸ªè´Ÿç”µè· + 3ä¸ªæ­£ç”µè·ï¼‰
        """
        return round(self._calculate_charge(ph), 2)

    def extinction_coefficient(self) -> tuple[float, float]:
        """
        è®¡ç®—æ¶ˆå…‰ç³»æ•°ï¼ˆ280nmï¼‰ã€‚

        æ¶ˆå…‰ç³»æ•°ç”¨äºé€šè¿‡ç´«å¤–å¸æ”¶æµ‹å®šè›‹ç™½è´¨æµ“åº¦ã€‚
        è¿”å›ä¸¤ä¸ªå€¼ï¼š
        - è¿˜åŸæ€ï¼ˆäºŒç¡«é”®è¢«è¿˜åŸï¼‰
        - æ°§åŒ–æ€ï¼ˆäºŒç¡«é”®å½¢æˆï¼‰

        è®¡ç®—å…¬å¼ï¼ˆPace et al., 1995ï¼‰ï¼š
        Îµ = nTyr Ã— 1490 + nTrp Ã— 5500 + nCys Ã— 125ï¼ˆæ°§åŒ–æ€ï¼‰

        Returns:
            (è¿˜åŸæ€æ¶ˆå…‰ç³»æ•°, æ°§åŒ–æ€æ¶ˆå…‰ç³»æ•°)ï¼Œå•ä½ Mâ»Â¹ cmâ»Â¹

        ç¤ºä¾‹ï¼š
            >>> ProteinSequence("WWYY").extinction_coefficient()
            (13960, 13960)  # æ—  Cysï¼Œä¸¤ä¸ªå€¼ç›¸åŒ
        """
        n_trp = self._sequence.count("W")
        n_tyr = self._sequence.count("Y")
        n_cys = self._sequence.count("C")

        # è¿˜åŸæ€ï¼šCys ä¸è´¡çŒ®
        reduced = n_trp * 5500 + n_tyr * 1490

        # æ°§åŒ–æ€ï¼šå‡è®¾æ‰€æœ‰ Cys å½¢æˆäºŒç¡«é”®
        # æ¯å¯¹ Cys è´¡çŒ® 125
        oxidized = reduced + (n_cys // 2) * 125

        return (reduced, oxidized)

    def get_properties(self) -> ProteinProperties:
        """
        è·å–è›‹ç™½è´¨çš„ä¸»è¦ç†åŒ–æ€§è´¨ã€‚

        Returns:
            ProteinProperties å¯¹è±¡

        ç¤ºä¾‹ï¼š
            >>> props = ProteinSequence("MKFLILLFNILCLFPVLAADNH").get_properties()
            >>> print(f"MW: {props.molecular_weight:.1f} Da")
            >>> print(f"pI: {props.isoelectric_point:.2f}")
        """
        return ProteinProperties(
            molecular_weight=self.molecular_weight(),
            isoelectric_point=self.isoelectric_point(),
            charge_at_ph7=self.charge_at_ph(7.0),
            gravy=self.gravy(),
            extinction_coefficient=self.extinction_coefficient(),
        )
```

### æ­¥éª¤ 2ï¼šå®Œå–„ RNA åˆ°è›‹ç™½è´¨çš„å·¥ä½œæµ

æ›´æ–° `src/genomeflow/rna.py`ï¼Œä¿®æ”¹ `translate` æ–¹æ³•è¿”å› `ProteinSequence`ï¼š

```python
# åœ¨ rna.py ä¸­æ·»åŠ æ–°çš„ç¿»è¯‘æ–¹æ³•

def translate_to_protein(
    self,
    start_codon: bool = True,
    stop_at_stop: bool = True,
) -> "ProteinSequence":
    """
    å°† RNA ç¿»è¯‘ä¸ºè›‹ç™½è´¨åºåˆ—å¯¹è±¡ã€‚

    Args:
        start_codon: æ˜¯å¦ä»èµ·å§‹å¯†ç å­å¼€å§‹
        stop_at_stop: æ˜¯å¦åœ¨ç»ˆæ­¢å¯†ç å­å¤„åœæ­¢

    Returns:
        ProteinSequence å¯¹è±¡

    ç¤ºä¾‹ï¼š
        >>> rna = RNASequence("AUGUUUUAA")
        >>> protein = rna.translate_to_protein()
        >>> protein.molecular_weight()
    """
    from genomeflow.protein import ProteinSequence

    result = self.translate(start_codon, stop_at_stop)
    # ç§»é™¤ç»ˆæ­¢ç¬¦å·ï¼ˆå¦‚æœæœ‰ï¼‰
    protein_seq = result.protein.replace("*", "")
    return ProteinSequence(protein_seq, strict=True)
```

### æ­¥éª¤ 3ï¼šæ›´æ–°åŒ…å¯¼å‡º

æ›´æ–° `src/genomeflow/__init__.py`ï¼š

```python
"""
GenomeFlow - åºåˆ—åˆ†æå·¥å…·

æ”¯æŒ DNAã€RNA å’Œè›‹ç™½è´¨åºåˆ—çš„åˆ†æã€‚
"""

from genomeflow.base import BaseSequence, InvalidSequenceError
from genomeflow.sequence import DNASequence
from genomeflow.rna import RNASequence, TranslationResult, CODON_TABLE
from genomeflow.protein import (
    ProteinSequence,
    InvalidProteinError,
    AminoAcidComposition,
    ProteinProperties,
    AMINO_ACIDS,
    AMINO_ACID_WEIGHTS,
    HYDROPHOBICITY,
)
from genomeflow.analyzer import (
    gc_content,
    base_frequency,
    find_motif,
    transcribe,
    calculate_molecular_weight,
    BaseFrequency,
)
from genomeflow.io import read_fasta, write_fasta, FastaRecord

__version__ = "0.1.0"

__all__ = [
    # åŸºç±»
    "BaseSequence",
    "InvalidSequenceError",
    # DNA
    "DNASequence",
    # RNA
    "RNASequence",
    "TranslationResult",
    "CODON_TABLE",
    # è›‹ç™½è´¨
    "ProteinSequence",
    "InvalidProteinError",
    "AminoAcidComposition",
    "ProteinProperties",
    "AMINO_ACIDS",
    "AMINO_ACID_WEIGHTS",
    "HYDROPHOBICITY",
    # åˆ†æ
    "gc_content",
    "base_frequency",
    "find_motif",
    "transcribe",
    "calculate_molecular_weight",
    "BaseFrequency",
    # IO
    "read_fasta",
    "write_fasta",
    "FastaRecord",
]
```

### æ­¥éª¤ 4ï¼šç¼–å†™æµ‹è¯•

åˆ›å»º `tests/test_protein.py`ï¼š

```python
"""è›‹ç™½è´¨åºåˆ—çš„å•å…ƒæµ‹è¯•ã€‚"""

import pytest

from genomeflow.protein import (
    ProteinSequence,
    InvalidProteinError,
)


class TestProteinSequenceCreation:
    """æµ‹è¯• ProteinSequence çš„åˆ›å»ºã€‚"""

    def test_create_valid_sequence(self):
        protein = ProteinSequence("MKFLILLFNILCLFPVLAADNH")
        assert len(protein) == 22

    def test_lowercase_converted(self):
        protein = ProteinSequence("mkfl")
        assert str(protein) == "MKFL"

    def test_invalid_character_rejected(self):
        with pytest.raises(InvalidProteinError):
            ProteinSequence("MKXFL")  # X åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹æ— æ•ˆ

    def test_non_strict_mode(self):
        protein = ProteinSequence("MKX*", strict=False)
        assert "X" in str(protein)
        assert "*" in str(protein)

    def test_invalid_base_rejected(self):
        with pytest.raises(InvalidProteinError):
            ProteinSequence("ATGC")  # è¿™æ˜¯ DNAï¼Œä¸æ˜¯è›‹ç™½è´¨


class TestMolecularWeight:
    """æµ‹è¯•åˆ†å­é‡è®¡ç®—ã€‚"""

    def test_single_amino_acid(self):
        # Glycine (G) åˆ†å­é‡ 75.07
        protein = ProteinSequence("G")
        mw = protein.molecular_weight()
        assert mw == pytest.approx(75.07, rel=0.01)

    def test_dipeptide(self):
        # M + K - H2Oï¼ˆè‚½é”®è„±æ°´ï¼‰+ H2Oï¼ˆæœ«ç«¯ï¼‰
        protein = ProteinSequence("MK")
        mw = protein.molecular_weight()
        # 149.21 + 146.19 - 18.015 + 18.015 = 295.40
        expected = 149.21 + 146.19
        assert mw == pytest.approx(expected, rel=0.01)


class TestAminoAcidComposition:
    """æµ‹è¯•æ°¨åŸºé…¸ç»„æˆåˆ†æã€‚"""

    def test_composition(self):
        protein = ProteinSequence("AAAKKK")
        comp = protein.amino_acid_composition()
        assert comp.counts["A"] == 3
        assert comp.counts["K"] == 3
        assert comp.frequencies["A"] == pytest.approx(0.5)

    def test_total_count(self):
        protein = ProteinSequence("MKFLILLFNILCLFPVLAADNH")
        comp = protein.amino_acid_composition()
        assert comp.total == 22


class TestHydrophobicity:
    """æµ‹è¯•ç–æ°´æ€§åˆ†æã€‚"""

    def test_hydrophobic_protein(self):
        # I, L, V æ˜¯å¼ºç–æ°´æ°¨åŸºé…¸
        protein = ProteinSequence("ILVILVILVILVILVIL")
        gravy = protein.gravy()
        assert gravy > 3.0  # åº”è¯¥æ˜¯æ­£å€¼ï¼ˆç–æ°´ï¼‰

    def test_hydrophilic_protein(self):
        # D, E, K, R æ˜¯äº²æ°´æ°¨åŸºé…¸
        protein = ProteinSequence("DEKRDEKRDEKR")
        gravy = protein.gravy()
        assert gravy < -3.0  # åº”è¯¥æ˜¯è´Ÿå€¼ï¼ˆäº²æ°´ï¼‰

    def test_hydrophobicity_profile(self):
        protein = ProteinSequence("MILVAGFYWDEKR")
        profile = protein.hydrophobicity_profile(window=5)
        assert len(profile) > 0
        # å¼€å¤´ç–æ°´ï¼Œç»“å°¾äº²æ°´
        assert profile[0] > profile[-1]


class TestIsoelectricPoint:
    """æµ‹è¯•ç­‰ç”µç‚¹è®¡ç®—ã€‚"""

    def test_acidic_protein(self):
        # å¯Œå«é…¸æ€§æ°¨åŸºé…¸
        protein = ProteinSequence("DDDEEEMMM")
        pi = protein.isoelectric_point()
        assert pi < 5.0  # é…¸æ€§è›‹ç™½è´¨ pI ä½

    def test_basic_protein(self):
        # å¯Œå«ç¢±æ€§æ°¨åŸºé…¸
        protein = ProteinSequence("KKKRRRMMMM")
        pi = protein.isoelectric_point()
        assert pi > 9.0  # ç¢±æ€§è›‹ç™½è´¨ pI é«˜


class TestExtinctionCoefficient:
    """æµ‹è¯•æ¶ˆå…‰ç³»æ•°è®¡ç®—ã€‚"""

    def test_no_aromatic(self):
        # æ²¡æœ‰ W, Y, C
        protein = ProteinSequence("AAAAKKKKK")
        reduced, oxidized = protein.extinction_coefficient()
        assert reduced == 0
        assert oxidized == 0

    def test_with_tryptophan(self):
        protein = ProteinSequence("WWAAA")
        reduced, oxidized = protein.extinction_coefficient()
        assert reduced == 2 * 5500  # 2 ä¸ª Trp

    def test_with_cysteine(self):
        protein = ProteinSequence("CCAAA")
        reduced, oxidized = protein.extinction_coefficient()
        assert oxidized > reduced  # æ°§åŒ–æ€è€ƒè™‘äºŒç¡«é”®


class TestGetProperties:
    """æµ‹è¯•ç»¼åˆå±æ€§è·å–ã€‚"""

    def test_get_properties(self):
        protein = ProteinSequence("MKFLILLFNILCLFPVLAADNH")
        props = protein.get_properties()

        assert props.molecular_weight > 0
        assert 0 < props.isoelectric_point < 14
        assert isinstance(props.gravy, float)
        assert len(props.extinction_coefficient) == 2
```

---

## âœ… å®Œæ•´å·¥ä½œæµç¤ºä¾‹

ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°å®Œæ•´çš„"ä¸­å¿ƒæ³•åˆ™"å·¥ä½œæµï¼š

```python
from genomeflow import DNASequence

# 1. DNA åºåˆ—
dna = DNASequence("ATGAAATTTGGGCCCTAGATG")
print(f"DNA: {dna}")
print(f"é•¿åº¦: {len(dna)} bp")
print(f"GC å«é‡: {dna.gc_content():.1%}")

# 2. è½¬å½•ä¸º RNA
rna = dna.transcribe()
print(f"\nRNA: {rna}")

# 3. ç¿»è¯‘ä¸ºè›‹ç™½è´¨
result = rna.translate()
print(f"\nç¿»è¯‘ç»“æœ:")
print(f"  è›‹ç™½è´¨: {result.protein}")
print(f"  é‡åˆ°ç»ˆæ­¢å¯†ç å­: {result.stop_codon}")

# 4. åˆ†æè›‹ç™½è´¨æ€§è´¨
if result.protein:
    from genomeflow import ProteinSequence
    protein = ProteinSequence(result.protein.replace("*", ""))

    props = protein.get_properties()
    print(f"\nè›‹ç™½è´¨æ€§è´¨:")
    print(f"  åˆ†å­é‡: {props.molecular_weight:.1f} Da")
    print(f"  ç­‰ç”µç‚¹: {props.isoelectric_point:.2f}")
    print(f"  pH 7.0 å‡€ç”µè·: {props.charge_at_ph7:+.1f}")
    print(f"  GRAVY: {props.gravy:.2f}")

    comp = protein.amino_acid_composition()
    print(f"\næ°¨åŸºé…¸ç»„æˆ:")
    print(comp)
```

---

## ğŸ¤” æ·±å…¥æ€è€ƒ

<details>
<summary>ä¸ºä»€ä¹ˆ ProteinSequence ä¸ç»§æ‰¿ BaseSequenceï¼Ÿ</summary>

è™½ç„¶è›‹ç™½è´¨åºåˆ—å’Œæ ¸é…¸åºåˆ—æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼ˆéƒ½æ˜¯çº¿æ€§åºåˆ—ï¼‰ï¼Œä½†ï¼š

1. **æ ¸å¿ƒæ¦‚å¿µä¸åŒ**ï¼š
   - æ ¸é…¸æœ‰äº’è¡¥é…å¯¹ï¼Œè›‹ç™½è´¨æ²¡æœ‰
   - æ ¸é…¸æœ‰æ–¹å‘ï¼ˆ5'â†’3'ï¼‰ï¼Œè›‹ç™½è´¨ä¹Ÿæœ‰ï¼ˆNâ†’Cï¼‰ï¼Œä½†æ„ä¹‰ä¸åŒ

2. **é¿å…ä¸æ°å½“çš„ç»§æ‰¿**ï¼š
   - å¦‚æœç»§æ‰¿ BaseSequenceï¼Œä¼šç»§æ‰¿ `complement()` æ–¹æ³•
   - è›‹ç™½è´¨æ²¡æœ‰"äº’è¡¥é“¾"æ¦‚å¿µï¼Œè¿™ä¼šé€ æˆæ··æ·†

3. **è®¾è®¡åŸåˆ™**ï¼š
   - ç»§æ‰¿åº”è¯¥è¡¨ç¤º"is-a"å…³ç³»
   - è›‹ç™½è´¨ä¸æ˜¯"ä¸€ç§æ ¸é…¸"

å¦‚æœéœ€è¦ç»Ÿä¸€æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ Protocolï¼š

```python
from typing import Protocol

class SequenceProtocol(Protocol):
    def __len__(self) -> int: ...
    def __getitem__(self, index: int) -> str: ...
```

</details>

<details>
<summary>ç­‰ç”µç‚¹è®¡ç®—çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</summary>

ç­‰ç”µç‚¹ï¼ˆpIï¼‰æ˜¯è›‹ç™½è´¨å‡€ç”µè·ä¸ºé›¶æ—¶çš„ pHã€‚

**å¯è§£ç¦»åŸºå›¢**ï¼š
- Nç«¯æ°¨åŸºï¼ˆpKa â‰ˆ 9.7ï¼‰
- Cç«¯ç¾§åŸºï¼ˆpKa â‰ˆ 2.3ï¼‰
- ä¾§é“¾ï¼šD, Eï¼ˆé…¸æ€§ï¼‰ï¼ŒH, K, Rï¼ˆç¢±æ€§ï¼‰ï¼ŒC, Yï¼ˆç‰¹æ®Šï¼‰

**Henderson-Hasselbalch æ–¹ç¨‹**ï¼š
```
pH = pKa + log([Aâ»]/[HA])
```

å¯¹äºé…¸æ€§åŸºå›¢ï¼ˆå¤±å» H å¸¦è´Ÿç”µï¼‰ï¼š
```
ç”µè· = -1 / (1 + 10^(pKa - pH))
```

å¯¹äºç¢±æ€§åŸºå›¢ï¼ˆè·å¾— H å¸¦æ­£ç”µï¼‰ï¼š
```
ç”µè· = +1 / (1 + 10^(pH - pKa))
```

**äºŒåˆ†æŸ¥æ‰¾**ï¼šåœ¨ pH 0-14 èŒƒå›´å†…æœç´¢å‡€ç”µè·ä¸º 0 çš„ç‚¹ã€‚

</details>

---

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™ä¸ªæ•™ç¨‹ï¼Œä½ å­¦ä¼šäº†ï¼š

1. **è›‹ç™½è´¨åŸºç¡€**ï¼š20 ç§æ°¨åŸºé…¸çš„æ€§è´¨å’Œåˆ†ç±»
2. **ProteinSequence ç±»**ï¼šç‹¬ç«‹äºæ ¸é…¸çš„åºåˆ—ç±»
3. **ç†åŒ–æ€§è´¨è®¡ç®—**ï¼šåˆ†å­é‡ã€ç­‰ç”µç‚¹ã€ç–æ°´æ€§ã€æ¶ˆå…‰ç³»æ•°
4. **å®Œæ•´å·¥ä½œæµ**ï¼šDNA â†’ RNA â†’ è›‹ç™½è´¨ â†’ æ€§è´¨åˆ†æ

ä¸‹ä¸€æ­¥ï¼š[æ•™ç¨‹ 04 - åºåˆ—å¯è§†åŒ–](tutorial-04-visualization.md)
